<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>rapace WebSocket Client Demo</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
                background: #1a1a2e;
                color: #eaeaea;
            }
            h1 {
                color: #00d9ff;
            }
            .section {
                background: #16213e;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
            }
            h2 {
                margin-top: 0;
                color: #00d9ff;
            }
            button {
                background: #00d9ff;
                color: #1a1a2e;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-right: 10px;
                margin-bottom: 10px;
            }
            button:hover {
                background: #00b8d9;
            }
            button:disabled {
                background: #555;
                cursor: not-allowed;
            }
            button.secondary {
                background: #0f3460;
                color: #00d9ff;
                border: 1px solid #00d9ff;
            }
            button.secondary:hover {
                background: #1a4a7a;
            }
            input,
            textarea {
                background: #0f3460;
                border: 1px solid #00d9ff;
                color: #eaeaea;
                padding: 8px 12px;
                border-radius: 4px;
                margin-right: 10px;
                font-family: inherit;
            }
            input {
                width: 200px;
            }
            textarea {
                width: 100%;
                min-height: 80px;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 13px;
            }
            #log {
                background: #0f0f1a;
                border: 1px solid #333;
                border-radius: 4px;
                padding: 15px;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 13px;
                max-height: 300px;
                overflow-y: auto;
                white-space: pre-wrap;
            }
            .log-info {
                color: #00d9ff;
            }
            .log-success {
                color: #00ff88;
            }
            .log-error {
                color: #ff6b6b;
            }
            .log-stream {
                color: #ffd93d;
            }
            .status {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                margin-left: 10px;
            }
            .status-connected {
                background: #00ff88;
                color: #1a1a2e;
            }
            .status-disconnected {
                background: #ff6b6b;
                color: white;
            }
            .status-connecting {
                background: #ffd93d;
                color: #1a1a2e;
            }
            .service-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }
            .service-card {
                background: #0f3460;
                border: 1px solid #00d9ff;
                border-radius: 4px;
                padding: 10px 15px;
                cursor: pointer;
                transition: background 0.2s;
            }
            .service-card:hover {
                background: #1a4a7a;
            }
            .service-card.selected {
                background: #00d9ff;
                color: #1a1a2e;
            }
            .method-list {
                margin-top: 15px;
            }
            .method-item {
                background: #0f0f1a;
                border: 1px solid #333;
                border-radius: 4px;
                padding: 12px;
                margin-bottom: 10px;
            }
            .method-name {
                color: #00d9ff;
                font-weight: bold;
                font-family: "Monaco", "Menlo", monospace;
            }
            .method-doc {
                color: #888;
                font-size: 12px;
                margin-top: 4px;
            }
            .method-args {
                margin-top: 10px;
            }
            .arg-input {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 8px;
            }
            .arg-label {
                min-width: 80px;
                color: #ffd93d;
            }
            .streaming-badge {
                background: #ffd93d;
                color: #1a1a2e;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
                margin-left: 8px;
            }
            #services-container,
            #methods-container {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>rapace Explorer Demo</h1>

        <div class="section">
            <h2>
                Connection <span id="status" class="status status-disconnected">Disconnected</span>
            </h2>
            <input type="text" id="wsUrl" value="ws://127.0.0.1:4268" placeholder="WebSocket URL" />
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        </div>

        <div class="section" id="services-container">
            <h2>Services</h2>
            <div id="service-list" class="service-list"></div>
            <button class="secondary" onclick="refreshServices()">Refresh Services</button>
        </div>

        <div class="section" id="methods-container">
            <h2>Methods for <span id="selected-service-name">-</span></h2>
            <div id="method-list" class="method-list"></div>
        </div>

        <div class="section">
            <h2>Log</h2>
            <button class="secondary" onclick="clearLog()">Clear</button>
            <div id="log"></div>
        </div>

        <script type="module">
            import init, { ExplorerClient } from "./pkg/rapace_wasm_client.js";

            let client = null;
            let services = [];
            let selectedService = null;

            function log(msg, className = "log-info") {
                const logEl = document.getElementById("log");
                const timestamp = new Date().toLocaleTimeString();
                logEl.innerHTML += `<span class="${className}">[${timestamp}] ${msg}</span>\n`;
                logEl.scrollTop = logEl.scrollHeight;
            }

            window.clearLog = function () {
                document.getElementById("log").innerHTML = "";
            };

            function setStatus(status) {
                const statusEl = document.getElementById("status");
                statusEl.textContent = status;
                statusEl.className = "status status-" + status.toLowerCase();
            }

            function setConnected(connected) {
                document.getElementById("connectBtn").disabled = connected;
                document.getElementById("disconnectBtn").disabled = !connected;
                document.getElementById("wsUrl").disabled = connected;
                document.getElementById("services-container").style.display = connected
                    ? "block"
                    : "none";
                if (!connected) {
                    document.getElementById("methods-container").style.display = "none";
                }
            }

            window.connect = async function () {
                try {
                    setStatus("Connecting");
                    log("Initializing WASM module...");
                    await init();

                    const url = document.getElementById("wsUrl").value;
                    log(`Connecting to ${url}...`);
                    client = await ExplorerClient.connect(url);

                    setStatus("Connected");
                    setConnected(true);
                    log("Connected!", "log-success");

                    // Auto-discover services
                    await refreshServices();
                } catch (e) {
                    setStatus("Disconnected");
                    setConnected(false);
                    log("Connection failed: " + e, "log-error");
                }
            };

            window.disconnect = function () {
                if (client) {
                    client.close();
                    client = null;
                }
                setStatus("Disconnected");
                setConnected(false);
                services = [];
                selectedService = null;
                log("Disconnected");
            };

            window.refreshServices = async function () {
                if (!client) return;

                try {
                    log("Discovering services...");
                    services = await client.listServices();
                    log(`Found ${services.length} service(s)`, "log-success");

                    renderServices();
                } catch (e) {
                    log("Failed to list services: " + e, "log-error");
                }
            };

            function renderServices() {
                const container = document.getElementById("service-list");
                container.innerHTML = "";

                for (const svc of services) {
                    const card = document.createElement("div");
                    card.className =
                        "service-card" + (selectedService?.id === svc.id ? " selected" : "");
                    card.innerHTML = `<strong>${svc.name}</strong><br><small>${svc.method_count} methods</small>`;
                    card.onclick = () => selectService(svc);
                    container.appendChild(card);
                }
            }

            async function selectService(svc) {
                selectedService = svc;
                renderServices();

                document.getElementById("selected-service-name").textContent = svc.name;
                document.getElementById("methods-container").style.display = "block";

                try {
                    log(`Loading methods for ${svc.name}...`);
                    const details = await client.getService(svc.id);

                    if (details) {
                        renderMethods(details);
                        log(`Loaded ${details.methods.length} method(s)`, "log-success");
                    } else {
                        log("Service not found", "log-error");
                    }
                } catch (e) {
                    log("Failed to get service details: " + e, "log-error");
                }
            }

            function renderMethods(service) {
                const container = document.getElementById("method-list");
                container.innerHTML = "";

                for (const method of service.methods) {
                    const item = document.createElement("div");
                    item.className = "method-item";

                    let argsHtml = "";
                    for (const arg of method.args) {
                        argsHtml += `
                        <div class="arg-input">
                            <span class="arg-label">${arg.name}:</span>
                            <input type="text" id="arg-${method.id}-${arg.name}"
                                   placeholder="${arg.type_name}"
                                   data-shape='${JSON.stringify(arg.shape)}'>
                        </div>
                    `;
                    }

                    item.innerHTML = `
                    <div>
                        <span class="method-name">${method.name}</span>
                        ${method.is_streaming ? '<span class="streaming-badge">streaming</span>' : ""}
                    </div>
                    ${method.doc ? `<div class="method-doc">${method.doc}</div>` : ""}
                    <div class="method-args">${argsHtml}</div>
                    <button onclick="callMethod('${service.name}', '${method.name}', ${method.id}, ${method.is_streaming}, ${JSON.stringify(method.args).replace(/"/g, "&quot;")})">
                        Call ${method.name}()
                    </button>
                `;

                    container.appendChild(item);
                }
            }

            window.callMethod = async function (
                serviceName,
                methodName,
                methodId,
                isStreaming,
                args,
            ) {
                if (!client) {
                    log("Not connected", "log-error");
                    return;
                }

                // Collect argument values
                const argsObj = {};
                for (const arg of args) {
                    const input = document.getElementById(`arg-${methodId}-${arg.name}`);
                    const value = input.value;
                    const shape = JSON.parse(input.dataset.shape);

                    // Parse based on shape
                    argsObj[arg.name] = parseValue(value, shape);
                }

                log(`Calling ${serviceName}.${methodName}(${JSON.stringify(argsObj)})...`);

                try {
                    if (isStreaming) {
                        const stream = client.callStreaming(serviceName, methodName, argsObj);
                        let count = 0;

                        while (true) {
                            const item = await stream.next();
                            if (item === null) break;

                            const value = JSON.parse(item.value_json);
                            log(`  [${count}] ${JSON.stringify(value)}`, "log-stream");
                            count++;
                        }

                        log(`Stream complete (${count} items)`, "log-success");
                    } else {
                        const response = await client.callUnary(serviceName, methodName, argsObj);

                        if (response.error) {
                            log(`Error: ${response.error}`, "log-error");
                        } else {
                            const result = JSON.parse(response.result_json);
                            log(`Result: ${JSON.stringify(result, null, 2)}`, "log-success");
                        }
                    }
                } catch (e) {
                    log("Call failed: " + e, "log-error");
                }
            };

            function parseValue(str, shape) {
                if (!str) return null;

                switch (shape.kind) {
                    case "Scalar":
                        if (shape.affinity === "integer" || shape.affinity === "unsigned") {
                            return parseInt(str, 10);
                        } else if (shape.affinity === "float") {
                            return parseFloat(str);
                        } else if (shape.affinity === "boolean") {
                            return str.toLowerCase() === "true";
                        }
                        return str;

                    case "String":
                        return str;

                    case "Option":
                        if (str === "" || str === "null") return null;
                        return parseValue(str, shape.inner);

                    case "List":
                        try {
                            return JSON.parse(str);
                        } catch {
                            return str.split(",").map((s) => parseValue(s.trim(), shape.item));
                        }

                    case "Struct":
                    case "Map":
                        try {
                            return JSON.parse(str);
                        } catch {
                            return str;
                        }

                    default:
                        // Try JSON parse, fall back to string
                        try {
                            return JSON.parse(str);
                        } catch {
                            return str;
                        }
                }
            }

            // Init
            log('Page loaded. Enter WebSocket URL and click "Connect" to start.');
        </script>
    </body>
</html>
