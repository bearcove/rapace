<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapace Service Explorer</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-header h1::before {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 6px;
        }

        .search-box {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .service-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .service-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            margin-bottom: 4px;
        }

        .service-item:hover {
            background: var(--bg-tertiary);
        }

        .service-item.active {
            background: var(--bg-tertiary);
            border-left: 2px solid var(--accent-blue);
        }

        .service-item-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .service-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Main content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
        }

        .welcome-screen {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-secondary);
        }

        .welcome-screen h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .welcome-screen p {
            font-size: 14px;
        }

        /* Service detail */
        .service-detail {
            max-width: 900px;
        }

        .service-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .service-name {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .service-doc {
            color: var(--text-secondary);
            font-size: 15px;
            white-space: pre-wrap;
        }

        .methods-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .method-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 12px;
        }

        .method-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .method-name {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .method-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .badge-unary {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .badge-streaming {
            background: rgba(163, 113, 247, 0.15);
            color: var(--accent-purple);
        }

        .method-doc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 12px;
            white-space: pre-wrap;
        }

        .method-signature {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .sig-label {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .sig-type {
            color: var(--accent-orange);
        }

        .sig-arg-name {
            color: var(--accent-blue);
        }

        .sig-arrow {
            color: var(--text-muted);
            margin: 0 8px;
        }

        /* Call section */
        .call-section {
            margin-top: 12px;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }

        .call-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .call-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .call-toggle.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .call-form {
            margin-top: 12px;
        }

        .call-form label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .call-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 12px;
        }

        .call-form textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .call-button {
            background: var(--accent-green);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.15s;
        }

        .call-button:hover {
            opacity: 0.9;
        }

        .call-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .call-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .call-result.success {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid rgba(63, 185, 80, 0.3);
            color: var(--accent-green);
        }

        .call-result.error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: var(--accent-red);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state */
        .error-box {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.4);
            color: #f85149;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }

        /* Streaming output */
        .stream-output {
            margin-top: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
        }

        .stream-output.active {
            border-color: var(--accent-purple);
        }

        .stream-item {
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .stream-item:last-child {
            border-bottom: none;
        }

        .stream-item.error {
            color: var(--accent-red);
        }

        .stream-item .item-index {
            color: var(--text-muted);
            margin-right: 8px;
        }

        .stream-status {
            font-size: 12px;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .stream-status.streaming {
            background: rgba(163, 113, 247, 0.15);
            color: var(--accent-purple);
        }

        .stream-status.completed {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .stream-status.error {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }

        .stop-stream-button {
            background: var(--accent-red);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-left: 8px;
        }

        .stop-stream-button:hover {
            opacity: 0.9;
        }

        .stream-button {
            background: var(--accent-purple);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.15s;
        }

        .stream-button:hover {
            opacity: 0.9;
        }

        .stream-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Typed form controls */
        .typed-form {
            margin-bottom: 12px;
        }

        .typed-field {
            margin-bottom: 12px;
        }

        .typed-field-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .typed-field-label .field-type {
            color: var(--accent-orange);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            margin-left: 6px;
        }

        .typed-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .typed-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .typed-input[type="number"] {
            width: 150px;
        }

        .typed-input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .mode-toggle label {
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .mode-toggle input[type="checkbox"] {
            cursor: pointer;
        }

        /* Struct fieldset */
        .struct-fieldset {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .struct-fieldset legend {
            color: var(--text-secondary);
            font-size: 12px;
            padding: 0 8px;
        }

        /* Option wrapper */
        .option-wrapper {
            border-left: 2px solid var(--border-color);
            padding-left: 12px;
            margin-left: 4px;
        }

        .option-wrapper.has-value {
            border-left-color: var(--accent-blue);
        }

        /* List controls */
        .list-wrapper {
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            padding: 12px;
        }

        .list-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .list-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-index {
            color: var(--text-muted);
            font-size: 11px;
            min-width: 20px;
            padding-top: 8px;
        }

        .remove-list-item {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
        }

        .add-list-item {
            background: none;
            border: 1px dashed var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            transition: all 0.15s;
            margin-top: 8px;
        }

        .add-list-item:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Enum select */
        .typed-select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .typed-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .enum-variant-fields {
            margin-top: 8px;
            padding-left: 12px;
            border-left: 2px solid var(--accent-purple);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { html, render, useState, useEffect, useRef } from 'https://esm.sh/htm/preact/standalone';
        import init, { ExplorerClient } from '/pkg/rapace_wasm_client.js';

        // ============================================================================
        // Shape Input Components
        // ============================================================================

        // Get default value for a shape
        function getDefaultValue(shape) {
            if (!shape) return null;
            switch (shape.kind) {
                case 'Scalar':
                    if (shape.affinity === 'boolean') return false;
                    if (shape.affinity === 'float') return 0.0;
                    return 0;
                case 'String':
                    return '';
                case 'Option':
                    return null;
                case 'List':
                    return [];
                case 'Struct':
                    const obj = {};
                    for (const field of shape.fields || []) {
                        obj[field.name] = getDefaultValue(field.shape);
                    }
                    return obj;
                case 'Enum':
                    // Default to first variant
                    const firstVariant = (shape.variants || [])[0];
                    if (firstVariant && firstVariant.fields) {
                        const data = {};
                        for (const f of firstVariant.fields) {
                            data[f.name] = getDefaultValue(f.shape);
                        }
                        return { [firstVariant.name]: data };
                    }
                    return firstVariant ? firstVariant.name : null;
                case 'Map':
                    return {};
                default:
                    return null;
            }
        }

        // Recursive shape input component
        function ShapeInput({ shape, value, onChange, label }) {
            if (!shape) {
                return html`<div class="error-box">Unknown shape</div>`;
            }

            switch (shape.kind) {
                case 'Scalar':
                    return html`<${ScalarInput} shape=${shape} value=${value} onChange=${onChange} />`;
                case 'String':
                    return html`<input
                        type="text"
                        class="typed-input"
                        value=${value ?? ''}
                        onInput=${e => onChange(e.target.value)}
                        placeholder="Enter text..."
                    />`;
                case 'Option':
                    return html`<${OptionInput} shape=${shape} value=${value} onChange=${onChange} />`;
                case 'List':
                    return html`<${ListInput} shape=${shape} value=${value} onChange=${onChange} />`;
                case 'Struct':
                    return html`<${StructInput} shape=${shape} value=${value} onChange=${onChange} />`;
                case 'Enum':
                    return html`<${EnumInput} shape=${shape} value=${value} onChange=${onChange} />`;
                case 'Map':
                    return html`<${MapInput} shape=${shape} value=${value} onChange=${onChange} />`;
                default:
                    return html`<div class="error-box">Unsupported shape: ${shape.kind}</div>`;
            }
        }

        function ScalarInput({ shape, value, onChange }) {
            if (shape.affinity === 'boolean') {
                return html`
                    <div class="checkbox-wrapper">
                        <input
                            type="checkbox"
                            class="typed-input"
                            checked=${!!value}
                            onChange=${e => onChange(e.target.checked)}
                        />
                        <span>${value ? 'true' : 'false'}</span>
                    </div>
                `;
            }

            const isFloat = shape.affinity === 'float';
            return html`<input
                type="number"
                class="typed-input"
                value=${value ?? ''}
                step=${isFloat ? 'any' : '1'}
                onInput=${e => {
                    const v = e.target.value;
                    if (v === '') {
                        onChange(0);
                    } else if (isFloat) {
                        onChange(parseFloat(v) || 0);
                    } else {
                        onChange(parseInt(v, 10) || 0);
                    }
                }}
            />`;
        }

        function OptionInput({ shape, value, onChange }) {
            const hasValue = value !== null && value !== undefined;

            return html`
                <div class="option-wrapper ${hasValue ? 'has-value' : ''}">
                    <div class="checkbox-wrapper" style="margin-bottom: 8px;">
                        <input
                            type="checkbox"
                            checked=${hasValue}
                            onChange=${e => {
                                if (e.target.checked) {
                                    onChange(getDefaultValue(shape.inner));
                                } else {
                                    onChange(null);
                                }
                            }}
                        />
                        <span style="font-size: 12px; color: var(--text-secondary)">
                            ${hasValue ? 'Some' : 'None'}
                        </span>
                    </div>
                    ${hasValue && html`
                        <${ShapeInput}
                            shape=${shape.inner}
                            value=${value}
                            onChange=${onChange}
                        />
                    `}
                </div>
            `;
        }

        function ListInput({ shape, value, onChange }) {
            const items = Array.isArray(value) ? value : [];

            const addItem = () => {
                onChange([...items, getDefaultValue(shape.item)]);
            };

            const removeItem = (index) => {
                const newItems = [...items];
                newItems.splice(index, 1);
                onChange(newItems);
            };

            const updateItem = (index, newValue) => {
                const newItems = [...items];
                newItems[index] = newValue;
                onChange(newItems);
            };

            return html`
                <div class="list-wrapper">
                    ${items.map((item, i) => html`
                        <div class="list-item" key=${i}>
                            <span class="list-item-index">[${i}]</span>
                            <div class="list-item-content">
                                <${ShapeInput}
                                    shape=${shape.item}
                                    value=${item}
                                    onChange=${v => updateItem(i, v)}
                                />
                            </div>
                            <button
                                class="remove-list-item"
                                onClick=${() => removeItem(i)}
                                title="Remove item"
                            >x</button>
                        </div>
                    `)}
                    <button class="add-list-item" onClick=${addItem}>
                        + Add item
                    </button>
                </div>
            `;
        }

        function StructInput({ shape, value, onChange }) {
            const obj = value && typeof value === 'object' ? value : {};
            const fields = shape.fields || [];

            const updateField = (name, newValue) => {
                onChange({ ...obj, [name]: newValue });
            };

            return html`
                <div class="struct-fieldset">
                    ${fields.map(field => html`
                        <div class="typed-field" key=${field.name}>
                            <label class="typed-field-label">
                                ${field.name}
                                <span class="field-type">${getShapeTypeName(field.shape)}</span>
                            </label>
                            <${ShapeInput}
                                shape=${field.shape}
                                value=${obj[field.name]}
                                onChange=${v => updateField(field.name, v)}
                            />
                        </div>
                    `)}
                </div>
            `;
        }

        function EnumInput({ shape, value, onChange }) {
            const variants = shape.variants || [];

            // Figure out current variant
            let currentVariant = null;
            let currentData = null;

            if (typeof value === 'string') {
                // Unit variant
                currentVariant = value;
            } else if (value && typeof value === 'object') {
                // Data variant: { VariantName: { ... } }
                const keys = Object.keys(value);
                if (keys.length === 1) {
                    currentVariant = keys[0];
                    currentData = value[currentVariant];
                }
            }

            if (!currentVariant && variants.length > 0) {
                currentVariant = variants[0].name;
            }

            const variantDef = variants.find(v => v.name === currentVariant);

            const handleVariantChange = (newVariantName) => {
                const newVariantDef = variants.find(v => v.name === newVariantName);
                if (newVariantDef && newVariantDef.fields) {
                    const data = {};
                    for (const f of newVariantDef.fields) {
                        data[f.name] = getDefaultValue(f.shape);
                    }
                    onChange({ [newVariantName]: data });
                } else {
                    onChange(newVariantName);
                }
            };

            const handleDataChange = (newData) => {
                onChange({ [currentVariant]: newData });
            };

            return html`
                <div>
                    <select
                        class="typed-select"
                        value=${currentVariant}
                        onChange=${e => handleVariantChange(e.target.value)}
                    >
                        ${variants.map(v => html`
                            <option value=${v.name} key=${v.name}>${v.name}</option>
                        `)}
                    </select>
                    ${variantDef && variantDef.fields && html`
                        <div class="enum-variant-fields">
                            <${StructInput}
                                shape=${{ fields: variantDef.fields }}
                                value=${currentData || {}}
                                onChange=${handleDataChange}
                            />
                        </div>
                    `}
                </div>
            `;
        }

        function MapInput({ shape, value, onChange }) {
            // For now, show as raw JSON since maps are complex
            const [jsonStr, setJsonStr] = useState(JSON.stringify(value || {}, null, 2));

            const handleChange = (str) => {
                setJsonStr(str);
                try {
                    onChange(JSON.parse(str));
                } catch (e) {
                    // Invalid JSON, don't update
                }
            };

            return html`
                <textarea
                    class="typed-input"
                    style="min-height: 60px; font-family: monospace;"
                    value=${jsonStr}
                    onInput=${e => handleChange(e.target.value)}
                    placeholder="{ }"
                />
            `;
        }

        // Get a friendly type name for a shape
        function getShapeTypeName(shape) {
            if (!shape) return '?';
            switch (shape.kind) {
                case 'Scalar':
                    return shape.type_name?.split('::').pop() || shape.affinity;
                case 'String':
                    return 'String';
                case 'Option':
                    return `Option<${getShapeTypeName(shape.inner)}>`;
                case 'List':
                    return `Vec<${getShapeTypeName(shape.item)}>`;
                case 'Struct':
                    return shape.type_name?.split('::').pop() || 'struct';
                case 'Enum':
                    return shape.type_name?.split('::').pop() || 'enum';
                case 'Map':
                    return `Map<${getShapeTypeName(shape.key)}, ${getShapeTypeName(shape.value)}>`;
                default:
                    return shape.kind;
            }
        }

        // ============================================================================
        // Method Form Component
        // ============================================================================

        function MethodForm({ client, serviceName, method }) {
            const [expanded, setExpanded] = useState(false);
            const [useRawJson, setUseRawJson] = useState(false);
            const [formValue, setFormValue] = useState(() => {
                // Initialize from method args
                const initial = {};
                for (const arg of method.args || []) {
                    initial[arg.name] = getDefaultValue(arg.shape);
                }
                return initial;
            });
            const [rawJson, setRawJson] = useState(() => JSON.stringify(formValue, null, 2));
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            // For streaming
            const [streamItems, setStreamItems] = useState([]);
            const [streaming, setStreaming] = useState(false);
            const [streamStatus, setStreamStatus] = useState(null);
            const stopRef = useRef(false);

            // Sync rawJson when formValue changes (if not in raw mode)
            useEffect(() => {
                if (!useRawJson) {
                    setRawJson(JSON.stringify(formValue, null, 2));
                }
            }, [formValue, useRawJson]);

            const getArgs = () => {
                if (useRawJson) {
                    return JSON.parse(rawJson);
                }
                return formValue;
            };

            // Handle Enter key to submit
            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !loading && !streaming) {
                    e.preventDefault();
                    if (method.is_streaming) {
                        handleStream();
                    } else {
                        handleCall();
                    }
                }
            };

            const handleCall = async () => {
                setLoading(true);
                setResult(null);
                setError(null);

                try {
                    const args = getArgs();
                    const response = await client.callUnary(serviceName, method.name, args);

                    if (response.error) {
                        setError(response.error);
                    } else {
                        setResult(JSON.parse(response.result_json));
                    }
                } catch (e) {
                    setError(String(e));
                } finally {
                    setLoading(false);
                }
            };

            const handleStream = async () => {
                setStreaming(true);
                setStreamItems([]);
                setStreamStatus('streaming');
                setError(null);
                stopRef.current = false;

                try {
                    const args = getArgs();
                    const stream = client.callStreaming(serviceName, method.name, args);

                    let count = 0;
                    while (!stopRef.current) {
                        const item = await stream.next();
                        if (item === null) break;

                        count++;
                        const value = JSON.parse(item.value_json);
                        setStreamItems(prev => [...prev, { index: count, value }]);
                    }

                    setStreamStatus(stopRef.current ? 'stopped' : 'completed');
                } catch (e) {
                    setError(String(e));
                    setStreamStatus('error');
                } finally {
                    setStreaming(false);
                }
            };

            const handleStopStream = () => {
                stopRef.current = true;
            };

            if (!expanded) {
                return html`
                    <div class="call-section">
                        <button class="call-toggle" onClick=${() => setExpanded(true)}>
                            Try it
                        </button>
                    </div>
                `;
            }

            return html`
                <div class="call-section">
                    <button class="call-toggle active" onClick=${() => setExpanded(false)}>
                        Try it
                    </button>

                    <div class="call-form" onKeyDown=${handleKeyDown}>
                        <div class="mode-toggle">
                            <label>
                                <input
                                    type="checkbox"
                                    checked=${useRawJson}
                                    onChange=${e => setUseRawJson(e.target.checked)}
                                />
                                Raw JSON mode
                            </label>
                        </div>

                        ${useRawJson ? html`
                            <label>Arguments (JSON)</label>
                            <textarea
                                value=${rawJson}
                                onInput=${e => setRawJson(e.target.value)}
                                placeholder="{}"
                            />
                        ` : html`
                            <div class="typed-form">
                                ${(method.args || []).map(arg => html`
                                    <div class="typed-field" key=${arg.name}>
                                        <label class="typed-field-label">
                                            ${arg.name}
                                            <span class="field-type">${arg.type_name}</span>
                                        </label>
                                        <${ShapeInput}
                                            shape=${arg.shape}
                                            value=${formValue[arg.name]}
                                            onChange=${v => setFormValue(prev => ({ ...prev, [arg.name]: v }))}
                                        />
                                    </div>
                                `)}
                                ${(method.args || []).length === 0 && html`
                                    <div style="color: var(--text-muted); font-size: 13px;">
                                        No arguments required
                                    </div>
                                `}
                            </div>
                        `}

                        <div style="margin-top: 12px;">
                            ${method.is_streaming ? html`
                                <button
                                    class="stream-button"
                                    onClick=${handleStream}
                                    disabled=${streaming}
                                >
                                    ${streaming ? 'Streaming...' : 'Start Stream'}
                                </button>
                                ${streaming && html`
                                    <button class="stop-stream-button" onClick=${handleStopStream}>
                                        Stop
                                    </button>
                                `}
                            ` : html`
                                <button
                                    class="call-button"
                                    onClick=${handleCall}
                                    disabled=${loading}
                                >
                                    ${loading ? 'Calling...' : `Call ${method.name}`}
                                </button>
                            `}
                        </div>

                        ${error && html`
                            <div class="call-result error">${error}</div>
                        `}

                        ${result !== null && html`
                            <div class="call-result success">${JSON.stringify(result, null, 2)}</div>
                        `}

                        ${method.is_streaming && streamStatus && html`
                            <div class="stream-status ${streamStatus}">
                                ${streamStatus === 'streaming' ? 'Streaming...' :
                                  streamStatus === 'completed' ? `Completed (${streamItems.length} items)` :
                                  streamStatus === 'stopped' ? `Stopped (${streamItems.length} items)` :
                                  'Error'}
                            </div>
                        `}

                        ${method.is_streaming && streamItems.length > 0 && html`
                            <div class="stream-output ${streaming ? 'active' : ''}">
                                ${streamItems.map(item => html`
                                    <div class="stream-item" key=${item.index}>
                                        <span class="item-index">[${item.index}]</span>
                                        ${JSON.stringify(item.value)}
                                    </div>
                                `)}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // Method Card Component
        // ============================================================================

        function MethodCard({ client, serviceName, method }) {
            return html`
                <div class="method-card">
                    <div class="method-header">
                        <span class="method-name">${method.name}</span>
                        <span class="method-badge ${method.is_streaming ? 'badge-streaming' : 'badge-unary'}">
                            ${method.is_streaming ? 'Streaming' : 'Unary'}
                        </span>
                    </div>

                    ${method.doc && html`
                        <div class="method-doc">${method.doc.trim()}</div>
                    `}

                    <div class="method-signature">
                        <div class="sig-label">Arguments</div>
                        ${(method.args || []).length > 0 ? html`
                            ${method.args.map((arg, i) => html`
                                <span key=${arg.name}>
                                    ${i > 0 ? ', ' : ''}
                                    <span class="sig-arg-name">${arg.name}</span>: <span class="sig-type">${arg.type_name}</span>
                                </span>
                            `)}
                        ` : html`
                            <span class="sig-type">(none)</span>
                        `}
                        <span class="sig-arrow">-></span>
                        <span class="sig-type">
                            ${method.is_streaming ? `Stream<${method.response_type}>` : method.response_type}
                        </span>
                    </div>

                    <${MethodForm} client=${client} serviceName=${serviceName} method=${method} />
                </div>
            `;
        }

        // ============================================================================
        // Service Detail Component
        // ============================================================================

        function ServiceDetail({ client, service }) {
            return html`
                <div class="service-detail">
                    <div class="service-header">
                        <h2 class="service-name">${service.name}</h2>
                        ${service.doc && html`
                            <div class="service-doc">${service.doc.trim()}</div>
                        `}
                    </div>

                    <div class="methods-section">
                        <h3>Methods (${service.methods?.length || 0})</h3>
                        ${(service.methods || []).map(method => html`
                            <${MethodCard}
                                key=${method.id}
                                client=${client}
                                serviceName=${service.name}
                                method=${method}
                            />
                        `)}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // Sidebar Component
        // ============================================================================

        function Sidebar({ services, selectedId, onSelect, searchTerm, onSearchChange }) {
            const filtered = services.filter(s =>
                s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (s.doc || '').toLowerCase().includes(searchTerm.toLowerCase())
            );

            return html`
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <h1>Rapace Explorer</h1>
                    </div>
                    <div class="search-box">
                        <input
                            type="text"
                            placeholder="Search services..."
                            value=${searchTerm}
                            onInput=${e => onSearchChange(e.target.value)}
                        />
                    </div>
                    <div class="service-list">
                        ${filtered.length === 0 && html`
                            <div class="loading" style="animation: none;">No services found</div>
                        `}
                        ${filtered.map(service => html`
                            <div
                                key=${service.id}
                                class="service-item ${service.id === selectedId ? 'active' : ''}"
                                onClick=${() => onSelect(service.id)}
                            >
                                <div class="service-item-name">${service.name}</div>
                                <div class="service-item-meta">
                                    ${service.method_count} method${service.method_count !== 1 ? 's' : ''}
                                </div>
                            </div>
                        `)}
                    </div>
                </aside>
            `;
        }

        // ============================================================================
        // Main App Component
        // ============================================================================

        function App() {
            const [client, setClient] = useState(null);
            const [services, setServices] = useState([]);
            const [selectedServiceId, setSelectedServiceId] = useState(null);
            const [selectedService, setSelectedService] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(true);
            const [loadingService, setLoadingService] = useState(false);

            // Initialize client and load services
            useEffect(() => {
                async function initClient() {
                    try {
                        await init();
                        const c = await ExplorerClient.connect('ws://127.0.0.1:4268');
                        setClient(c);

                        const serviceList = await c.listServices();
                        setServices(serviceList);
                        setLoading(false);
                    } catch (e) {
                        setError(`Failed to connect: ${e}`);
                        setLoading(false);
                    }
                }
                initClient();
            }, []);

            // Load service details when selected
            useEffect(() => {
                if (!client || selectedServiceId === null) {
                    setSelectedService(null);
                    return;
                }

                async function loadService() {
                    setLoadingService(true);
                    try {
                        const service = await client.getService(selectedServiceId);
                        setSelectedService(service);
                    } catch (e) {
                        setError(`Failed to load service: ${e}`);
                    } finally {
                        setLoadingService(false);
                    }
                }
                loadService();
            }, [client, selectedServiceId]);

            if (loading) {
                return html`
                    <div class="container">
                        <aside class="sidebar">
                            <div class="sidebar-header">
                                <h1>Rapace Explorer</h1>
                            </div>
                            <div class="service-list">
                                <div class="loading">Loading services</div>
                            </div>
                        </aside>
                        <main class="main-content">
                            <div class="welcome-screen">
                                <h2>Connecting...</h2>
                                <p>Connecting to WebSocket server</p>
                            </div>
                        </main>
                    </div>
                `;
            }

            if (error) {
                return html`
                    <div class="container">
                        <aside class="sidebar">
                            <div class="sidebar-header">
                                <h1>Rapace Explorer</h1>
                            </div>
                            <div class="service-list">
                                <div class="error-box">${error}</div>
                            </div>
                        </aside>
                        <main class="main-content">
                            <div class="welcome-screen">
                                <h2>Connection Error</h2>
                                <p>Could not connect to the rapace server</p>
                            </div>
                        </main>
                    </div>
                `;
            }

            return html`
                <div class="container">
                    <${Sidebar}
                        services=${services}
                        selectedId=${selectedServiceId}
                        onSelect=${setSelectedServiceId}
                        searchTerm=${searchTerm}
                        onSearchChange=${setSearchTerm}
                    />
                    <main class="main-content">
                        ${loadingService && html`
                            <div class="loading">Loading service details</div>
                        `}
                        ${!loadingService && !selectedService && html`
                            <div class="welcome-screen">
                                <h2>Service Explorer</h2>
                                <p>Select a service from the sidebar to view its methods and documentation.</p>
                            </div>
                        `}
                        ${!loadingService && selectedService && html`
                            <${ServiceDetail} client=${client} service=${selectedService} />
                        `}
                    </main>
                </div>
            `;
        }

        // Mount the app
        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
